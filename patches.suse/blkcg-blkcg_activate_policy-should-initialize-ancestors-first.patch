From: Tejun Heo <tj@kernel.org>
Date: Thu, 13 Jun 2019 15:30:40 -0700
Subject: blkcg: blkcg_activate_policy() should initialize ancestors first
Git-commit: 71c814077de60b2e7415dac6f5c4e98f59d521fd
Patch-mainline: v5.3-rc1
References: CVE-2021-47379 bsc#1225203

When blkcg_activate_policy() is creating blkg_policy_data for existing
blkgs, it did in the wrong order - descendants first.  Fix it.  None
of the existing controllers seem affected by this.

Signed-off-by: Tejun Heo <tj@kernel.org>
Signed-off-by: Jens Axboe <axboe@kernel.dk>
Acked-by: Michal Koutn√Ω <mkoutny@suse.com>
[ mkoutny: adjust context for missing 0d945c1f966b2 ("block: remove the queue_lock indirection") v5.0-rc1~52^2~230 ]
---
 block/blk-cgroup.c |    3 ++-
 1 file changed, 2 insertions(+), 1 deletion(-)

--- a/block/blk-cgroup.c
+++ b/block/blk-cgroup.c
@@ -1306,7 +1306,8 @@ pd_prealloc:
 
 	spin_lock_irq(q->queue_lock);
 
-	list_for_each_entry(blkg, &q->blkg_list, q_node) {
+	/* blkg_list is pushed at the head, reverse walk to init parents first */
+	list_for_each_entry_reverse(blkg, &q->blkg_list, q_node) {
 		struct blkg_policy_data *pd;
 
 		if (blkg->pd[pol->plid])
